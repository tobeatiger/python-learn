<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Python 终端</title>
    <link rel="stylesheet" href="./index.css">
    <link rel="stylesheet" href="./floating-button.css">
    <script src="./lib/ace/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="./lib/ace/src-min/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
    <script src="./socket.io/socket.io.js"></script>
    <script src="./jquery.min.js"></script>
    <script src="./floating-button.js"></script>
</head>
<body class="showProgram">
<div id="root">
    <aside id="program">
        <div id="editor_wrapper">
            <div id="txt_prg"></div>
        </div>
        <div class="buttons" style="display:flex;">
            <button id="btn_toggle_gutter" class="on">
                <span class="show-gutter">&gt;</span>
                <span class="hide-gutter">&lt;</span>
            </button>
            <button id="btn_cls">清空</button>
            <button id="btn_run">跑起来</button>
        </div>
        <div id="floating_btn">
            <span class="lt">&lt;</span>
            <span class="gt">&gt;</span>
        </div>
    </aside>
    <ul id="terminal">
    </ul>
    <div class="programList">
        <div class="content">
            <h2>程序学习</h2>
            <div class="script-block">
                <aside class="script-list">
                    <ul></ul>
                    <div class="nav-button">
                        <span class="lt">&lt;</span>
                        <span class="gt">&gt;</span>
                    </div>
                </aside>
                <div class="script-preview"></div>
            </div>
        </div>
    </div>
</div>
<script>

    function preFormat (code) {
        var rs = [];
        if(code) {
            code = code.split('\n');
            for(var i=0;i<code.length;i++) {
                var currLine = code[i];
                var nextLine = code[i+1];
                
                // 1. skip all empty lines if in indentation context
                if(nextLine === undefined      // end of program
                    || !(
                        currLine.trim() === ''  // currLine is empty line
                        &&
                        (
                            nextLine.trim() === ''   // nextLine is empty line
                            || /^\s/.test(nextLine)  // nextLine is indented, in indentation context
                        )
                    )
                ) {
                    rs.push(currLine);
                }

                // 2. add empty line after end of indentation
                if(
                    /^\s/.test(currLine)           // currLine is indented
                    && currLine.trim() !== ''      // currLine is not empty spaces
                    && (
                        nextLine === undefined                            // no nextLine (end of program)
                        || (!/^\s/.test(nextLine) && nextLine !== '')     // nextLine is NOT indented
                    )
                ) {
                    rs.push('');
                }
            }
        }
        return rs.join('\n');
    }

    function init () {

        var socket = io();
        var hist = [];
        var currHistIdx = -1;
        socket.emit('init', 'session init');
        socket.on('reply', function(msgs) {
            $('#terminal').find('li input').each(function () {
                $(this).after($('<span></span>').html(
                        $(this).val()
                                .replace(new RegExp(' ', 'g'), '&nbsp;')
                                .replace(new RegExp('>', 'g'), '&gt;')
                                .replace(new RegExp('<', 'g'), '&lt;')
                )).remove();
            });
            if(msgs) {
                msgs = msgs.split('\n');
                $.each(msgs, function (index, msg) {
                    var li$ = $('<li></li>').html(msg);
                    if(msg.trim() == '>>>' || index == (msgs.length - 1)) {
                        li$.append($('<input type="text"/>').focus().keypress(function(e) {
                            if(e.which == 13) {
                                socket.emit('command', $(this).val());
                                if($(this).val().trim() !== hist[hist.length - 1]) {
                                    hist.push($(this).val());
                                }
                                currHistIdx = hist.length;
                            }
                        }).keydown(function(e) {
                            switch (e.which) {
                                case 38:  // up
                                    e.preventDefault();  // prevent (scroll/move caret)
                                    if(currHistIdx > 0) {
                                        currHistIdx--;
                                    }
                                    if(hist[currHistIdx]) {
                                        $(this).val(hist[currHistIdx]);
                                    }
                                    break;
                                case 40:  // down
                                    e.preventDefault();  // prevent (scroll/move caret)
                                    if(currHistIdx < hist.length - 1) {
                                        currHistIdx++;
                                    }
                                    if(hist[currHistIdx]) {
                                        $(this).val(hist[currHistIdx]);
                                    }
                                    break;
                                default: return;  // exit for other keys
                            }
                        }));
                    }
                    li$.appendTo($('#terminal'));
                });
                $('#terminal').find('li input').focus();
            } else {
                $('#terminal').append('<li>Goodbye!</li>');
            }
        });

        var t$ = $('#terminal');
        t$.click(function () {
            t$.find('li:last-child input').focus();
            setTimeout(function () {
                t$.animate({ scrollTop: $('#terminal').get(0).scrollHeight }, 300);
            }, 200);
        });

        $('#btn_cls').click(function () {
            window._editor.setValue('', 1);
        });

        $('#btn_run').click(function () {
            // var pg = preFormat($('#txt_prg').val());
            // $('#txt_prg').val(pg);
            var pg = preFormat(window._editor.getValue());
            window._editor.setValue(pg, 1);
            if(pg && pg.trim().length > 0) {
                socket.emit('program', pg);
                if($(window).width() <= 720) {
                    setTimeout(function () {
                        $('body').toggleClass('showProgram');
                    }, 50);
                }
            }
        });

        $('#floating_btn').click(function () {
            $('body').toggleClass('showProgram');
        });

        window._editor = ace.edit('txt_prg');
        window._editor.$blockScrolling = Infinity;
        window._editor.setTheme('ace/theme/monokai');
        window._editor.setDisplayIndentGuides(true);
        window._editor.setShowPrintMargin(false);
        window._editor.setSelectionStyle('text');
        window._editor.setFontSize(12);
        window._editor.renderer.setPadding(8);
        window._editor.session.setMode('ace/mode/python');
        window._editor.session.setUseWrapMode(true);
        var options = { scrollPastEnd: true, tabSize: 2, useSoftTabs: true };
        if($(window).width() <= 720) {
            window._editor.renderer.setShowGutter(false);
            $('#btn_toggle_gutter').removeClass('on');
            window._editor.setShowFoldWidgets(false);
            window._editor.session.setFoldStyle('manual');
        } else {
            options.enableBasicAutocompletion = true;
            options.enableSnippets = true;
            options.enableLiveAutocompletion = true;
        }
        window._editor.setOptions(options);

        $('#btn_toggle_gutter').click(function () {
            $(this).toggleClass('on');
            window._editor.renderer.setShowGutter($(this).hasClass('on'));
        });

        $.ajax({
            url: './programs/welcome.py'
        }).done(function (pg) {
            // $('#txt_prg').val(pg);
            window._editor.setValue(pg, -1);
        });

        var pgList$ = $('body').find('.programList');
        var floatingBtn$ = $.floatingButton({
            target: $('#root'),
            btnName: 'miniController',
            alignBottom: true,
            onClick: function () {
                pgList$.find('.content').hide();
                pgList$.one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",
                        function() {
                            if(pgList$.hasClass('show')) {
                                pgList$.find('.content').show();
                            }
                        }
                );
                pgList$.toggleClass('show');
                if(pgList$.hasClass('show')) {
                    pgList$.css('bottom', '0').css('right', '0');
                } else {
                    pgList$.css('bottom', parseInt(floatingBtn$[0].style.bottom)+18).css('right', parseInt(floatingBtn$.css('right'))+15);
                }
                $(this).toggleClass('icon-more').toggleClass('icon-close');
            },
            dragEnded: function (bottom) {
                if(!pgList$.hasClass('show')) {
                    $('body').find('.programList').css('bottom', parseInt(bottom)+18).css('right', parseInt(floatingBtn$.css('right'))+15);
                }
            }
        });
        pgList$.css('bottom', parseInt(floatingBtn$[0].style.bottom)+18).css('right', parseInt(floatingBtn$.css('right'))+15);

        pgList$.find('.nav-button').click(function () {
            $(this).parent().toggleClass('hidden');
        });
    }

    function fireWhenReady() {
        if ($.floatingButton && window.io && window.ace) {
            init();
        } else {
            setTimeout(fireWhenReady, 100);
        }
    }
    $(document).ready(fireWhenReady);

</script>
</body>
</html>
