<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE" />
    <title>Python 终端</title>
    <link rel="stylesheet" href="./index.css">
    <script src="socket.io/socket.io.js"></script>
    <script src="./jquery.min.js"></script>
</head>
<body>
<aside id="program">
    <textarea id="txt_prg">print "Hello Python"</textarea>
    <button id="btn_run">Run</button>
</aside>
<ul id="terminal">
</ul>
<script>
    var socket = io();
    var hist = [];
    var currHistIdx = -1;
    socket.emit('init', 'session init');
    socket.on('reply', function(msgs) {
        $('#terminal').find('li input').each(function () {
            $(this).after('<span>' + $(this).val() + '</span>').remove();
        });
        if(msgs) {
            msgs = msgs.split('\n');
            $.each(msgs, function (index, msg) {
                var li$ = $('<li></li>').text(msg);
                if(msg.trim() == '>>>' || index == (msgs.length - 1)) {
                    li$.append($('<input type="text"/>').focus().keypress(function(e) {
                        if(e.which == 13) {
                            socket.emit('command', $(this).val());
                            if($(this).val().trim() !== hist[hist.length - 1]) {
                                hist.push($(this).val());
                            }
                            currHistIdx = hist.length;
                        }
                    }).keydown(function(e) {
                        switch (e.which) {
                            case 38:  // up
                                e.preventDefault();  // prevent (scroll/move caret)
                                if(currHistIdx > 0) {
                                    currHistIdx--;
                                }
                                if(hist[currHistIdx]) {
                                    $(this).val(hist[currHistIdx]);
                                }
                                break;
                            case 40:  // down
                                e.preventDefault();  // prevent (scroll/move caret)
                                if(currHistIdx < hist.length - 1) {
                                    currHistIdx++;
                                }
                                if(hist[currHistIdx]) {
                                    $(this).val(hist[currHistIdx]);
                                }
                                break;
                            default: return;  // exit for other keys
                        }
                    }));
                }
                li$.appendTo($('#terminal'));
            });
            $('#terminal').find('li input').focus();
        } else {
            $('#terminal').append('<li>Goodbye!</li>');
        }
    });

    $('#terminal').click(function () {
        $('#terminal').find('li:last-child input').focus();
    });

    $('#btn_run').click(function () {
        var pg = $('#txt_prg').val();
        if(pg && pg.trim().length > 0) {
            socket.emit('program', pg);
        }
    });
</script>
</body>
</html>