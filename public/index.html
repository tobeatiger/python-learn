<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Python 终端</title>
    <link rel="stylesheet" href="./index.css">
    <script src="socket.io/socket.io.js"></script>
    <script src="./jquery.min.js"></script>
</head>
<body class="showProgram">
<aside id="program">
    <textarea id="txt_prg"></textarea>
    <button id="btn_run">跑起来</button>
    <div id="floating_btn">
        <span class="lt">&lt;</span>
        <span class="gt">&gt;</span>
    </div>
</aside>
<ul id="terminal">
</ul>
<script>

    function preFormat (code) {
        var rs = [];
        if(code) {
            code = code.split('\n');
            for(var i=0;i<code.length;i++) {
                var currLine = code[i];
                var nextLine = code[i+1];
                
                // 1. skip all empty lines if in indentation context
                if(nextLine === undefined      // end of program
                    || !(
                        currLine.trim() === ''  // currLine is empty line
                        &&
                        (
                            nextLine.trim() === ''   // nextLine is empty line
                            || /^\s/.test(nextLine)  // nextLine is indented, in indentation context
                        )
                    )
                ) {
                    rs.push(currLine);
                }

                // 2. add empty line after end of indentation
                if(
                    /^\s/.test(currLine)           // currLine is indented
                    && currLine.trim() !== ''      // currLine is not empty spaces
                    && (
                        nextLine === undefined                            // no nextLine (end of program)
                        || (!/^\s/.test(nextLine) && nextLine !== '')     // nextLine is NOT indented
                    )
                ) {
                    rs.push('');
                }
            }
        }
        return rs.join('\n');
    }

    $(window).load(function () {

        var socket = io();
        var hist = [];
        var currHistIdx = -1;
        socket.emit('init', 'session init');
        socket.on('reply', function(msgs) {
            $('#terminal').find('li input').each(function () {
                $(this).after($('<span></span>').html(
                    $(this).val()
                        .replace(new RegExp(' ', 'g'), '&nbsp;')
                        .replace(new RegExp('>', 'g'), '&gt;')
                        .replace(new RegExp('<', 'g'), '&lt;')
                )).remove();
            });
            if(msgs) {
                msgs = msgs.split('\n');
                $.each(msgs, function (index, msg) {
                    var li$ = $('<li></li>').html(msg);
                    if(msg.trim() == '>>>' || index == (msgs.length - 1)) {
                        li$.append($('<input type="text"/>').focus().keypress(function(e) {
                            if(e.which == 13) {
                                socket.emit('command', $(this).val());
                                if($(this).val().trim() !== hist[hist.length - 1]) {
                                    hist.push($(this).val());
                                }
                                currHistIdx = hist.length;
                            }
                        }).keydown(function(e) {
                            switch (e.which) {
                                case 38:  // up
                                    e.preventDefault();  // prevent (scroll/move caret)
                                    if(currHistIdx > 0) {
                                        currHistIdx--;
                                    }
                                    if(hist[currHistIdx]) {
                                        $(this).val(hist[currHistIdx]);
                                    }
                                    break;
                                case 40:  // down
                                    e.preventDefault();  // prevent (scroll/move caret)
                                    if(currHistIdx < hist.length - 1) {
                                        currHistIdx++;
                                    }
                                    if(hist[currHistIdx]) {
                                        $(this).val(hist[currHistIdx]);
                                    }
                                    break;
                                default: return;  // exit for other keys
                            }
                        }));
                    }
                    li$.appendTo($('#terminal'));
                });
                $('#terminal').find('li input').focus();
            } else {
                $('#terminal').append('<li>Goodbye!</li>');
            }
        });

        var t$ = $('#terminal');
        t$.click(function () {
            t$.find('li:last-child input').focus();
            setTimeout(function () {
                t$.animate({ scrollTop: $('#terminal').get(0).scrollHeight }, 300);
            }, 200);
        });

        $('#btn_run').click(function () {
            var pg = preFormat($('#txt_prg').val());
            $('#txt_prg').val(pg);
            if(pg && pg.trim().length > 0) {
                socket.emit('program', pg);
                if($(window).width() <= 720) {
                    $('body').toggleClass('showProgram');
                }
            }
        });

        $('#floating_btn').click(function () {
            $('body').toggleClass('showProgram');
        });

        $.ajax({
            url: './programs/welcome.py'
        }).done(function (pg) {
            $('#txt_prg').val(pg);
        });

    });

</script>
</body>
</html>
